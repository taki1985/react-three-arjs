{"version":3,"sources":["../../src/ar/ar.js"],"names":["useFrame","useThree","ArToolkitContext","ArToolkitSource","React","createContext","useCallback","useEffect","useMemo","ARContext","videoDomElemSelector","AR","memo","tracking","children","sourceType","patternRatio","matrixCodeType","detectionMode","sourceWidth","sourceHeight","displayWidth","displayHeight","cameraParametersUrl","onCameraStreamReady","onCameraStreamError","gl","camera","arContext","arToolkitSource","arToolkitContext","onResize","onResizeElement","copyElementSizeTo","domElement","arController","canvas","projectionMatrix","copy","getProjectionMatrix","onUnmount","window","removeEventListener","dispose","cameraParam","video","document","querySelector","srcObject","getTracks","map","track","stop","remove","init","style","position","onloadedmetadata","addEventListener","ready","update","value","useAR","arValue","useContext"],"mappings":"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","sourcesContent":["import { useFrame, useThree } from '@react-three/fiber';\nimport { ArToolkitContext, ArToolkitSource } from '@ar-js-org/ar.js/three.js/build/ar-threex';\nimport React, { createContext, useCallback, useEffect, useMemo } from 'react';\n\nconst ARContext = createContext({});\nconst videoDomElemSelector = '#arjs-video';\n\nconst AR = React.memo(({ tracking = true, children, sourceType, patternRatio, matrixCodeType, detectionMode, sourceWidth, sourceHeight, displayWidth, displayHeight, cameraParametersUrl, onCameraStreamReady, onCameraStreamError }) => {\n  const { gl, camera } = useThree();\n\n  const arContext = useMemo(() => {\n    const arToolkitSource = new ArToolkitSource({ sourceWidth, sourceHeight, sourceType, displayWidth, displayHeight });\n    const arToolkitContext = new ArToolkitContext({\n      cameraParametersUrl,\n      detectionMode,\n      patternRatio,\n      matrixCodeType,\n    });\n\n    return { arToolkitContext, arToolkitSource };\n  }, [patternRatio, matrixCodeType, cameraParametersUrl, detectionMode, sourceWidth, sourceHeight, sourceType, displayWidth, displayHeight]);\n\n  const onResize = useCallback(() => {\n    const { arToolkitContext, arToolkitSource } = arContext;\n\n    arToolkitSource.onResizeElement();\n    arToolkitSource.copyElementSizeTo(gl.domElement);\n    if (arToolkitContext.arController !== null) {\n      arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);\n      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());\n    }\n  }, [gl, arContext, camera]);\n\n  const onUnmount = useCallback(() => {\n    window.removeEventListener('resize', onResize);\n\n    arContext.arToolkitContext.arController.dispose();\n    if (arContext.arToolkitContext.arController.cameraParam) {\n      arContext.arToolkitContext.arController.cameraParam.dispose();\n    }\n\n    delete arContext.arToolkitContext;\n    delete arContext.arToolkitSource;\n\n    const video = document.querySelector(videoDomElemSelector);\n    if (video) {\n      video.srcObject.getTracks().map((track) => track.stop());\n      video.remove();\n    }\n  }, [onResize, arContext]);\n\n  useEffect(() => {\n    arContext.arToolkitSource.init(() => {\n      const video = document.querySelector(videoDomElemSelector);\n      video.style.position = 'fixed';\n\n      video.onloadedmetadata = () => {\n        if (onCameraStreamReady) {\n          onCameraStreamReady();\n        }\n        onResize();\n      };\n    }, onCameraStreamError);\n\n    arContext.arToolkitContext.init(() => camera.projectionMatrix.copy(arContext.arToolkitContext.getProjectionMatrix()));\n\n    window.addEventListener('resize', onResize);\n\n    return onUnmount;\n  }, [arContext, camera, onCameraStreamReady, onCameraStreamError, onResize, onUnmount]);\n\n  useFrame(() => {\n    if (!tracking) {\n      return;\n    }\n\n    if (arContext.arToolkitSource && arContext.arToolkitSource.ready !== false) {\n      arContext.arToolkitContext.update(arContext.arToolkitSource.domElement);\n    }\n  });\n\n  const value = useMemo(() => ({ arToolkitContext: arContext.arToolkitContext }), [arContext]);\n\n  return <ARContext.Provider value={value}>{children}</ARContext.Provider>;\n});\n\nconst useAR = () => {\n  const arValue = React.useContext(ARContext);\n  return React.useMemo(() => ({ ...arValue }), [arValue]);\n};\n\nexport { AR, useAR };\n"],"file":"ar.js"}